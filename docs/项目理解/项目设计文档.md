# ERP 智能意图识别服务技术文档

## 项目概述

本项目基于 **FastAPI** 构建一个轻量、高效的意图识别（Intent Recognition）REST API 服务，底层使用 **Rasa NLU** 作为自然语言理解引擎。专为企业 ERP 系统设计，支持用户通过自然语言查询订单、库存、报表等业务，实现智能助手或聊天机器人前端的意图识别能力。

核心特点：

- 所有代码、训练数据、模型管理集中在同一个项目中，便于开发、迭代和维护
- 模型训练直接在项目内完成，无需额外 Rasa 项目
- 模型体积小（30~100MB）、加载快、推理延迟低
- 支持中文意图识别，适合国内 ERP 场景（如用友、金蝶、SAP 等）

## 技术栈

- Python ≥ 3.9
- FastAPI（后端 API 框架）
- Uvicorn（ASGI 服务器）
- Rasa ≥ 3.6（仅使用 NLU 部分，进行意图识别与实体提取）
- Pydantic（数据校验）

## 项目目录结构

```
erp-rasa-nlu-service/
├── app/                          # FastAPI 核心代码
│   ├── __init__.py
│   ├── main.py                   # FastAPI 应用入口
│   ├── api/
│   │   └── nlu_router.py         # 意图识别 API 路由
│   ├── core/
│   │   ├── config.py             # 配置管理（模型路径等）
│   │   └── rasa_loader.py        # Rasa 模型单例加载
│   └── schemas/
│       └── nlu_schema.py         # 请求/响应数据模型
├── rasa_data/                    # Rasa NLU 训练数据（全部放在项目内）
│   ├── nlu.yml                   # 意图定义 + 训练示例（核心文件）
│   └── config.yml                # NLU pipeline 配置
├── models/                       # 训练生成的模型文件
│   └── latest_nlu.tar.gz         # 固定名称的最新模型（服务加载此文件）
├── scripts/                      # 实用脚本
│   └── train_rasa_nlu.py         # 一键训练 NLU 模型脚本
├── tests/                        # 单元测试（可选）
├── .env                          # 环境变量（可选）
├── requirements.txt              # 依赖列表
├── Dockerfile                    # Docker 部署
└── README.md                     # 项目说明（本文件）
```

## 安装与环境准备

```bash
# 克隆或创建项目目录
git clone <your-repo> erp-rasa-nlu-service
cd erp-rasa-nlu-service

# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

`requirements.txt` 内容：

```
fastapi
uvicorn[standard]
rasa>=3.6
pydantic
python-dotenv  # 可选，用于 .env 配置
```

## 模型训练（项目内直接完成）

### 1. 编辑训练数据（rasa_data/nlu.yml）

```yaml
version: "3.1"
nlu:
- intent: greet
  examples: |
    - 你好
    - 早上好
    - 在吗

- intent: query_order
  examples: |
    - 查看我的订单状态
    - 订单12345在哪里了
    - 帮我查一下物流信息
    - 我的包裹发了吗
    - 订单什么时候到达

- intent: check_inventory
  examples: |
    - 产品A的库存有多少
    - iPhone还有货吗
    - 查询仓库库存数量
    - 物料B是否缺货

- intent: create_return
  examples: |
    - 我要退货
    - 申请退款
    - 这个商品不合适，想退掉
```

> 后续新增意图或补充示例，直接修改此文件即可。

### 2. 配置 pipeline（rasa_data/config.yml）

推荐轻量高效配置（模型小、速度快、准确率高）：

```yaml
language: zh

pipeline:
  - name: WhitespaceTokenizer
  - name: RegexFeaturizer
  - name: LexicalSyntacticFeaturizer
  - name: CountVectorsFeaturizer
  - name: CountVectorsFeaturizer
    analyzer: char_wb
    min_ngram: 1
    max_ngram: 4
  - name: DIETClassifier
    epochs: 100
  - name: FallbackClassifier
    threshold: 0.3
```

### 3. 一键训练模型

运行脚本：

```bash
python scripts/train_rasa_nlu.py
```

训练完成后，会在 `models/` 目录生成 `latest_nlu.tar.gz`。

> 训练时间：通常 30 秒 ~ 5 分钟（取决于数据量和机器性能）

### 4. 模型迭代流程（后期维护）

1. 修改 `rasa_data/nlu.yml`（添加新意图或示例）
2. 运行 `python scripts/train_rasa_nlu.py`
3. 重启 FastAPI 服务（或支持热加载）
4. 新模型立即生效

## FastAPI 服务核心代码

### app/core/config.py

```python
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent.parent

class Settings:
    MODEL_PATH: str = str(BASE_DIR / "models" / "latest_nlu.tar.gz")
    API_PORT: int = 8000

settings = Settings()
```

### app/core/rasa_loader.py

```python
from rasa.nlu.model import Interpreter
from app.core.config import settings
import os

class RasaNLULoader:
    _interpreter = None

    @classmethod
    def get_interpreter(cls):
        if cls._interpreter is None:
            if not os.path.exists(settings.MODEL_PATH):
                raise FileNotFoundError(f"模型文件不存在: {settings.MODEL_PATH}")
            cls._interpreter = Interpreter.load(settings.MODEL_PATH)
        return cls._interpreter

interpreter = RasaNLULoader.get_interpreter
```

### app/schemas/nlu_schema.py

```python
from pydantic import BaseModel
from typing import Dict, List, Optional

class TextInput(BaseModel):
    text: str

class IntentResult(BaseModel):
    name: str
    confidence: float

class EntityResult(BaseModel):
    entity: str
    value: str
    start: int
    end: int
    confidence: float

class NLUResponse(BaseModel):
    text: str
    intent: IntentResult
    entities: List[EntityResult] = []
    intent_ranking: List[Dict] = []
```

### app/api/nlu_router.py

```python
from fastapi import APIRouter, HTTPException
from app.schemas.nlu_schema import TextInput, NLUResponse
from app.core.rasa_loader import RasaNLULoader

router = APIRouter(prefix="/nlu", tags=["NLU"])

@router.post("/predict", response_model=NLUResponse)
async def predict_intent(input: TextInput):
    if not input.text.strip():
        raise HTTPException(status_code=400, detail="输入文本不能为空")

    interpreter = RasaNLULoader.get_interpreter()
    result = interpreter.parse(input.text)

    return NLUResponse(
        text=input.text,
        intent=result["intent"],
        entities=result.get("entities", []),
        intent_ranking=result.get("intent_ranking", [])[:5]
    )
```

### app/main.py

```python
from fastapi import FastAPI
from app.api.nlu_router import router as nlu_router

app = FastAPI(
    title="ERP Rasa NLU 意图识别服务",
    description="为ERP系统提供自然语言意图识别能力",
    version="1.0.0"
)

app.include_router(nlu_router)

@app.get("/")
async def root():
    return {"message": "ERP Rasa NLU Service is running!"}
```

## 启动服务

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

访问：

- API 文档：http://localhost:8000/docs
- 健康检查：http://localhost:8000/

## API 使用示例

```bash
curl -X POST http://localhost:8000/nlu/predict \
  -H "Content-Type: application/json" \
  -d '{"text": "帮我查一下订单12345的状态"}'
```

返回示例：

```json
{
  "text": "帮我查一下订单12345的状态",
  "intent": {"name": "query_order", "confidence": 0.98},
  "entities": [...],
  "intent_ranking": [...]
}
```

## 后续集成建议

- 在 FastAPI 中根据 `intent.name` 调用对应 ERP API（如订单查询、库存接口）
- 集成企业微信、钉钉、Web 前端聊天框
- 添加日志、认证、限流等生产级特性
- 支持模型热更新（不重启服务）

## 总结

本方案实现了：

- 模型训练 + 服务部署 全流程在一个项目内完成
- 轻量、高效、可维护性强
- 完美适配 ERP 系统自然语言交互需求

现在你可以直接复制本结构，开始落地实施！
有任何问题（如训练报错、接口调试），随时贴信息给我，我继续帮你解决。祝项目顺利上线！

