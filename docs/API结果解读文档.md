# API 返回结果解读文档

## 概述

本文档详细说明意图识别 API (`POST /nlu/predict`) 返回结果的各个字段含义，帮助开发者正确理解和使用识别结果。

## 返回结果结构

### 完整示例

```json
{
  "text": "你好么",
  "intent": {
    "name": "greet",
    "confidence": 0.999995231628418
  },
  "entities": [],
  "intent_ranking": [
    {
      "name": "greet",
      "confidence": 0.999995231628418
    },
    {
      "name": "create_return",
      "confidence": 0.0000048124161367013585
    },
    {
      "name": "check_inventory",
      "confidence": 1.3662576847650598e-8
    },
    {
      "name": "query_order",
      "confidence": 1.2054560016849791e-8
    }
  ]
}
```

## 字段详解

### 1. text（原始文本）

**类型**：`string`

**说明**：用户输入的原始文本，与请求中的 `text` 字段相同。

**示例**：
```json
"text": "你好么"
```

**用途**：
- 用于确认返回结果对应的输入文本
- 便于日志记录和调试
- 支持多轮对话时保持上下文

---

### 2. intent（识别的意图）

**类型**：`object`

**说明**：模型识别出的主要意图，包含意图名称和置信度。

**结构**：
```json
{
  "name": "greet",
  "confidence": 0.999995231628418
}
```

#### 2.1 name（意图名称）

**类型**：`string`

**说明**：识别出的意图名称。可能的值：

- **明确意图**：训练数据中定义的意图
  - `greet`：问候
  - `query_order`：查询订单
  - `check_inventory`：查询库存
  - `create_return`：退货申请
  - 其他自定义意图...

- **通用意图**：未识别到明确意图时返回
  - `nlu_fallback`：未识别/通用意图

**示例**：
```json
"name": "greet"
```

**判断逻辑**：
- 如果最高置信度 ≥ 0.3，返回对应的明确意图
- 如果所有明确意图置信度 < 0.3，返回 `nlu_fallback`

#### 2.2 confidence（置信度）

**类型**：`float`

**范围**：0.0 - 1.0

**说明**：模型对识别结果的信心程度。数值越高，表示模型越确信该意图是正确的。

**置信度解读**：

| 置信度范围 | 含义 | 建议处理 |
|-----------|------|----------|
| 0.9 - 1.0 | 非常确信 | 可以直接使用，无需人工确认 |
| 0.7 - 0.9 | 比较确信 | 可以使用，建议记录日志 |
| 0.5 - 0.7 | 中等确信 | 谨慎使用，建议人工确认 |
| 0.3 - 0.5 | 不太确信 | 建议人工确认或返回通用意图 |
| < 0.3 | 不确定 | 返回 `nlu_fallback`，需要引导用户 |

**示例解读**：
```json
"confidence": 0.999995231628418
```

这个置信度接近 1.0，表示模型非常确信输入文本是问候意图。

---

### 3. entities（实体列表）

**类型**：`array`

**说明**：从文本中提取的关键实体信息（如订单号、产品名称等）。

**结构**：
```json
[
  {
    "entity": "order_id",
    "value": "12345",
    "start": 7,
    "end": 12,
    "confidence": 0.95
  }
]
```

**字段说明**：

- `entity`：实体类型（如 `order_id`、`product_name`）
- `value`：实体值（提取出的具体内容）
- `start`：实体在文本中的起始位置（字符索引）
- `end`：实体在文本中的结束位置（字符索引）
- `confidence`：实体识别的置信度

**示例**：

**输入**：`"帮我查一下订单12345的状态"`

**输出**：
```json
"entities": [
  {
    "entity": "order_id",
    "value": "12345",
    "start": 7,
    "end": 12,
    "confidence": 0.95
  }
]
```

**空列表情况**：
```json
"entities": []
```

表示文本中没有提取到实体信息（如纯问候语、描述性文本等）。

---

### 4. intent_ranking（意图排名）

**类型**：`array`

**说明**：所有可能意图的排名列表（Top 5），按置信度从高到低排序。

**用途**：
- 了解模型的备选意图
- 当主要意图置信度较低时，可以参考排名
- 用于调试和分析模型表现

**结构**：
```json
[
  {
    "name": "greet",
    "confidence": 0.999995231628418
  },
  {
    "name": "create_return",
    "confidence": 0.0000048124161367013585
  },
  ...
]
```

**解读示例**：

```json
"intent_ranking": [
  {
    "name": "greet",
    "confidence": 0.999995231628418
  },
  {
    "name": "create_return",
    "confidence": 0.0000048124161367013585
  },
  {
    "name": "check_inventory",
    "confidence": 1.3662576847650598e-8
  },
  {
    "name": "query_order",
    "confidence": 1.2054560016849791e-8
  }
]
```

**解读**：
- **第1名**：`greet`（置信度 0.9999...）— 几乎确定是问候意图
- **第2名**：`create_return`（置信度 0.000004...）— 极低，几乎不可能
- **第3-4名**：置信度极低（科学计数法表示，接近 0）

**关键观察**：
- 主要意图（`greet`）的置信度远高于其他意图
- 其他意图的置信度都极低，说明模型判断非常明确
- 排名第一的意图与 `intent` 字段中的意图一致

---

## 实际场景解读

### 场景1：高置信度明确意图

**输入**：`"你好么"`

**返回结果**：
```json
{
  "text": "你好么",
  "intent": {
    "name": "greet",
    "confidence": 0.999995231628418
  },
  "entities": [],
  "intent_ranking": [...]
}
```

**解读**：
- ✅ **意图识别成功**：识别为 `greet`（问候）意图
- ✅ **置信度极高**：0.9999...（接近 1.0），模型非常确信
- ✅ **无实体**：问候语通常不包含业务实体
- ✅ **排名清晰**：主要意图远高于其他意图

**建议操作**：
- 直接使用识别结果，返回问候回复
- 无需人工确认

---

### 场景2：包含实体的查询意图

**输入**：`"帮我查一下订单12345的状态"`

**可能的返回结果**：
```json
{
  "text": "帮我查一下订单12345的状态",
  "intent": {
    "name": "query_order",
    "confidence": 0.98
  },
  "entities": [
    {
      "entity": "order_id",
      "value": "12345",
      "start": 7,
      "end": 12,
      "confidence": 0.95
    }
  ],
  "intent_ranking": [
    {"name": "query_order", "confidence": 0.98},
    {"name": "check_inventory", "confidence": 0.01},
    ...
  ]
}
```

**解读**：
- ✅ **意图识别**：`query_order`（查询订单）
- ✅ **置信度高**：0.98，非常确信
- ✅ **实体提取成功**：提取到订单号 `12345`
- ✅ **实体位置**：在文本的第 7-12 个字符位置

**建议操作**：
- 使用 `intent.name` 确定业务逻辑（查询订单）
- 使用 `entities[0].value` 获取订单号（12345）
- 调用订单查询 API，返回订单状态

---

### 场景3：低置信度/未识别意图

**输入**：`"今天天气不错"`

**可能的返回结果**：
```json
{
  "text": "今天天气不错",
  "intent": {
    "name": "nlu_fallback",
    "confidence": 0.25
  },
  "entities": [],
  "intent_ranking": [
    {"name": "greet", "confidence": 0.25},
    {"name": "query_order", "confidence": 0.15},
    ...
  ]
  ]
}
```

**解读**：
- ⚠️ **通用意图**：返回 `nlu_fallback`（未识别意图）
- ⚠️ **置信度低**：0.25 < 0.3，所有明确意图置信度都低于阈值
- ⚠️ **无实体**：未提取到实体信息

**建议操作**：
- 返回友好提示："抱歉，我没有理解您的意思"
- 提供使用示例或引导用户重新输入
- 记录日志，用于后续优化训练数据

---

### 场景4：中等置信度意图

**输入**：`"今天早上见了一个客户，第一次见面，需要录入系统"`

**可能的返回结果**：
```json
{
  "text": "今天早上见了一个客户，第一次见面，需要录入系统",
  "intent": {
    "name": "create_customer",
    "confidence": 0.65
  },
  "entities": [
    {
      "entity": "customer_name",
      "value": "客户",
      "start": 6,
      "end": 8,
      "confidence": 0.60
    }
  ],
  "intent_ranking": [
    {"name": "create_customer", "confidence": 0.65},
    {"name": "greet", "confidence": 0.20},
    ...
  ]
}
```

**解读**：
- ⚠️ **中等置信度**：0.65，在 0.5-0.7 范围内
- ⚠️ **需要谨慎**：虽然识别为 `create_customer`，但置信度不是特别高
- ✅ **有实体**：提取到客户信息

**建议操作**：
- 可以使用识别结果，但建议记录日志
- 如果业务关键，可以返回确认："您是要创建客户信息吗？"
- 查看 `intent_ranking` 确认备选意图

---

## 置信度阈值说明

### 系统阈值

系统使用 **0.3** 作为区分明确意图和通用意图的阈值：

- **≥ 0.3**：返回明确意图（如 `greet`、`query_order` 等）
- **< 0.3**：返回通用意图（`nlu_fallback`）

### 业务建议阈值

根据业务需求，可以设置不同的置信度阈值：

| 业务场景 | 建议阈值 | 说明 |
|---------|---------|------|
| 高风险操作（如删除、支付） | ≥ 0.9 | 必须高置信度才执行 |
| 一般查询操作 | ≥ 0.7 | 可以执行，记录日志 |
| 信息展示 | ≥ 0.5 | 可以展示，但标注不确定性 |
| 通用回复 | < 0.3 | 返回友好提示 |

---

## 使用建议

### 1. 意图判断流程

```
获取 API 返回结果
    ↓
检查 intent.name
    ├─ 明确意图（非 nlu_fallback）
    │   ├─ 检查 confidence
    │   │   ├─ ≥ 0.9：直接使用
    │   │   ├─ 0.7-0.9：使用，记录日志
    │   │   ├─ 0.5-0.7：谨慎使用，可确认
    │   │   └─ 0.3-0.5：建议确认或降级
    │   └─ 提取 entities（如有）
    │
    └─ 通用意图（nlu_fallback）
        └─ 返回友好提示 + 使用示例
```

### 2. 实体提取使用

```python
# 伪代码示例
result = api_response

# 检查是否有实体
if result["entities"]:
    for entity in result["entities"]:
        if entity["entity"] == "order_id":
            order_id = entity["value"]
            # 使用订单号查询订单
            order_info = query_order(order_id)
```

### 3. 意图排名使用

```python
# 当主要意图置信度较低时，查看排名
if result["intent"]["confidence"] < 0.7:
    top_3 = result["intent_ranking"][:3]
    # 可以提示用户："您是想 [意图1] 还是 [意图2]？"
```

---

## 常见问题

### Q1: 为什么置信度是科学计数法？

**A**: 当置信度极低时（接近 0），Python 可能使用科学计数法表示，如 `1.3662576847650598e-8` 表示约 0.00000001366。这表示该意图的可能性极低。

### Q2: intent_ranking 中的意图顺序是什么？

**A**: 按置信度从高到低排序。第一个是主要意图（与 `intent` 字段一致），后续是备选意图。

### Q3: 为什么 entities 是空数组？

**A**: 不是所有文本都包含实体。例如：
- 问候语（"你好"）通常没有实体
- 描述性文本可能没有明确的实体
- 模型可能无法从文本中提取实体

### Q4: 如何判断识别是否准确？

**A**: 主要看：
1. **置信度**：≥ 0.7 通常比较准确
2. **排名差距**：主要意图的置信度远高于第二名，说明判断明确
3. **业务验证**：结合实际业务场景验证结果

### Q5: 置信度低时怎么办？

**A**: 
- 如果 < 0.3：系统自动返回 `nlu_fallback`，可以提示用户重新表达
- 如果 0.3-0.7：可以返回确认消息，或查看 `intent_ranking` 提供选项
- 如果频繁出现低置信度：考虑优化训练数据，添加更多示例

---

## 最佳实践

1. **始终检查置信度**：根据置信度决定是否使用识别结果
2. **使用实体信息**：提取的实体可以直接用于业务逻辑
3. **记录日志**：记录低置信度的识别结果，用于优化模型
4. **降级处理**：当置信度低时，提供友好的降级方案
5. **用户引导**：对于 `nlu_fallback`，提供使用示例引导用户

---

## 总结

API 返回结果提供了丰富的识别信息：
- **intent**：主要识别结果（最重要）
- **confidence**：置信度（判断可靠性）
- **entities**：提取的实体（用于业务逻辑）
- **intent_ranking**：备选意图（用于分析和降级）

合理使用这些信息，可以构建更智能、更可靠的意图识别应用。

---

**文档版本**：v1.0  
**最后更新**：2024
